# Reference: <https://postmarketos.org/vendorkernel>
# Kernel config based on: arch/arm64/configs/beryllium_defconfig

pkgname="linux-xiaomi-beryllium"
pkgver=4.9.182
pkgrel=0
pkgdesc="Xiaomi Poco F1 kernel fork"
arch="aarch64"
_carch="arm64"
_flavor="xiaomi-beryllium"
url="https://kernel.org"
license="GPL-2.0-only"
options="!strip !check !tracedeps"
makedepends="perl sed installkernel bash gmp-dev bc linux-headers elfutils-dev devicepkg-dev"

# Compiler: latest GCC from Alpine
HOSTCC="${CC:-gcc}"
HOSTCC="${HOSTCC#${CROSS_COMPILE}}"

# Source
_repository="android_kernel_xiaomi_sdm845"
_commit="0c1feb8b3a7cc62aed52346331f64190e644cca9"
_config="config-${_flavor}.${arch}"
source="
	$pkgname-$_commit.tar.gz::https://github.com/LineageOS/${_repository}/archive/${_commit}.tar.gz
	$_config
	c931082266753855b830b9627bc4baa593e80296.patch
	ef5a17911af561c5e8f648fd2d4326945999b51c.patch
	8e025c90e9024bf65f997a7f41516228eefa64ca.patch
	6e45053b39e6d65592e46700ed1ccacabadd0f6f.patch
	e1c870c37e29dc4e65b52251a8536c2c26a92663.patch
	90406c8d515fdbe127eeb9a84bf5c7a1cd49db1c.patch
	clk-qcom-mdss-fix-in-tree-build.patch
	ca12964322de07846e58a8a185d22e83d5a9e83d.patch
	fix-kgsl-trace-h.patch
	35f553645648a363869701078abafba2f2a03a17.patch
	c95980947a455d4e7a637bece483f7a8f9f5143d.patch
	2b9da8f9b865a7251c3bc0a4e5b7e0271a734b09.patch
	33d5770282c92aad6739124867a2acfa9fc7f531.patch
	dde1abb7cd7b15d2882458ec913114fbf0541681.patch
	20c33d2332d199174492ab9f64e027c78b36bb8d.patch
	a6dcf6ec3a522c4244878b56e8db8aef601c8a54.patch
	71523a6481fa2f211b80754605d437dd245e3c0a.patch
	59c5c55b2c3585474b807c2eb9eb86e0a99ad99c.patch
	64fc7d961f7da3975b437578ff220be0900218ea.patch
	7e7dd3cc177ac0297ff308fa36ee8b2e93e9b215.patch
	76ca4ee7b4ef5f9a87688a5893e3bd5df819f455.patch
	a935fcd9bdf5d7e06143e557a42d861f549c809d.patch
	7c11e06361e707448e99dae7ef8ea6aa53d16375.patch
	0fc66875a59ec2c8912a70a9c9c845affda8ca22.patch
	83b0ace09f44f51477b91fb8184fc89efd38d108.patch
	cc5e8eceff89977f3ba1188edc4e565cde026b06.patch
	558f83819d68f4ea5da9945fcf205c89cc2a6086.patch	

	9850125e9e6c34794ae84b89d0d323e5d9978879.patch
	945cae4a8a1ca424670188bc9ab9c41bdcb99379.patch
"
builddir="$srcdir/${_repository}-${_commit}"

prepare() {
	default_prepare
	downstreamkernel_prepare "$srcdir" "$builddir" "$_config" "$_carch" "$HOSTCC"
}

build() {
	unset LDFLAGS
	make ARCH="$_carch" CC="${CC:-gcc}" \
		KBUILD_BUILD_VERSION="$((pkgrel + 1 ))-postmarketOS"
}

package() {
	# kernel.release
	install -D "$builddir/include/config/kernel.release" \
		"$pkgdir/usr/share/kernel/$_flavor/kernel.release"

	# zImage (find the right one)
	cd "$builddir/arch/$_carch/boot"
	_target="$pkgdir/boot/vmlinuz-$_flavor"
	for _zimg in zImage-dtb Image.gz-dtb *zImage Image; do
		[ -e "$_zimg" ] || continue
		msg "zImage found: $_zimg"
		install -Dm644 "$_zimg" "$_target"
		break
	done
	if ! [ -e "$_target" ]; then
		error "Could not find zImage in $PWD!"
		return 1
	fi
}

sha512sums="60f63841673f31e1faf9f26113e93ca5ccf83925618bc35d1f6e11744f2f0f295bf32cfb6f9ece1d104868ed12af5ac76dea2ee39b4fb26b0569c8779ce0d74d  linux-xiaomi-beryllium-0c1feb8b3a7cc62aed52346331f64190e644cca9.tar.gz
fd387f1d36d5bd65b082430af9a675f23720385b9852f02ab59d59ae6efb55e7a4da7cec1a362a8e485814058d91bb34ce59a81fd0def5a9bd66dad3540a10de  config-xiaomi-beryllium.aarch64
bb8b99ce0a3820200df1e387d7514347ee9c72c05623685ff6f417b577b5b5feb9b71eaa0b460c45d849091f513f94af0c73dc748ddbdda34880271d7d70c611  c931082266753855b830b9627bc4baa593e80296.patch
c5c9cd1044a625323088e3fdc5df69ed141f6a1a22ff8997298473d460db93ae07685eef65a50bf5e88515abac5a10980386d03e6b02f2f45217b3b8fd4fa8c1  ef5a17911af561c5e8f648fd2d4326945999b51c.patch
dea601dd2a5c889b3d47ce812bc7b2a59016273181757c7659151a76e27074bc80251455b9c4d8240fce65557bc95472aa15d567b619ac049316e878787a0f35  8e025c90e9024bf65f997a7f41516228eefa64ca.patch
00db7ada93b2babf1d5e8e01f8604d695eaa37391fd16ef629a8f2d892acdf13596190f98d9356eec095fb762292cec19ce114bf90f47391954d52418d655482  6e45053b39e6d65592e46700ed1ccacabadd0f6f.patch
74f53e9b67109a2eeda7105484e1f07abd4179baa915aa833cfa9780f508f4b393ecc1ba79a5934f95e2b95139d22aedf2d7c603c3fffce7c19632af48b5acae  e1c870c37e29dc4e65b52251a8536c2c26a92663.patch
5181d9b6a40f339fccb4cdabf0ff5d5feff068ae137beafcdd400d81cb868734cb827e2aadb1d8519dee4b808c8e24be08f57591ed84f1f65348d1300ea308ef  90406c8d515fdbe127eeb9a84bf5c7a1cd49db1c.patch
720c5856b7d1d8b3cb20f77507818b7fe1b4950d444f7ed20cb02d255987d8860d5ed293e81ea326f147af13004b524886c733123794ac62978fda13689a5189  clk-qcom-mdss-fix-in-tree-build.patch
241d68a147dd4d783060e0e926c7a2afd5b0d33dfb5b05a1a18714ed63f6b2fd508c560debb8969cf0ad3ab470612aafcae860addb0a7c268225455f6e96d947  ca12964322de07846e58a8a185d22e83d5a9e83d.patch
df48d1eeaab982a3605cd76876f59090946475a66b6a4a1cde03a295900c117d3e2d7e26dfb5f973f51c2125ce76b1676db7e88f34afeb68ec9c866c930bb425  fix-kgsl-trace-h.patch
bcab7dbd854d4104e56b8f256c37acf227a983f91b26162a709c1540f253b4888e470f9580493870736634af36c25486cdce069306b7331227da2bb5d106904f  35f553645648a363869701078abafba2f2a03a17.patch
448254db4faad5c397328060ef9f70701f22bf3a727c3f9ac186a1e06e9b5a6bef0e60ab0560e70b9fae1af605ed095862043b80a45ae1b0c2a6c47b3d51b975  c95980947a455d4e7a637bece483f7a8f9f5143d.patch
48ed58b6b2af5d388796b16c8633f67da8dd3a59afb6dc056ff7e04f3778fc76e2b3bebb20cc6a3cf160481b428f262ab247465e10677d7e2cd47533011fe105  2b9da8f9b865a7251c3bc0a4e5b7e0271a734b09.patch
e1446fd3c92ae2ad20eeac38b180b619d80f0e2735eb6231d34e0bc7e5349a4e137b92b02794415a314ec9dd6f4a692838e890fcc8c77e823a4dbde28f7a3f55  33d5770282c92aad6739124867a2acfa9fc7f531.patch
959ded708cb34111fcd34a6a66218102d9236a7936c34b949880461b6916c6b334b34a26bd04f5f23b08c679f31edd6fe6e0ddad0364659689da78b3bdbef1fe  dde1abb7cd7b15d2882458ec913114fbf0541681.patch
985a9b5d9c9bd43ae459b3b86d3ee6cb0356bca7d80fa41d6f65f7ff27d0a4de828e1001d0c3d3b3e7def6cbe87b0ea96b10e14680de8f74a66b5a49aa766f7e  20c33d2332d199174492ab9f64e027c78b36bb8d.patch
3b83b67af5dfe98cbdcd6fa422a293e60ee0028a892f3031885862542245a79e285fdf9b56514d421f8a5b297592317d6884dfc067dfcb26128c08804770076b  a6dcf6ec3a522c4244878b56e8db8aef601c8a54.patch
f518e747e771f6663c42a9e94fe07df4e82676dacdbb74b4b81c2a781219d32c583f59405945a78d429b3a0cf76b369b4c04781092daff1db60289646cbd4b3a  71523a6481fa2f211b80754605d437dd245e3c0a.patch
afbb9c9e7afd68a1e3d4f71275a31311aea004c185657ca983b4b720ecca6c3b763e97acb70ed47191017a4b464e8beda775ccad55d17242b9b8bd4f5bf3ddf8  59c5c55b2c3585474b807c2eb9eb86e0a99ad99c.patch
1dee7e4c2a000119b0b9df783158e1098dce46eca6d82d970ab655f9116e3b7cac43c658047fe8a8f6f1cc6028b3bcf25bbc6e043da6f8c7d02d4565a6f62ba8  64fc7d961f7da3975b437578ff220be0900218ea.patch
155db75f092459f017b23455f2d67a42764da0f617f42ff38b1165013fc3cf9ce3a4b8e1b9732abb976bcdac9c2605ea92a678f26ca886f77a2554baad3ffa02  7e7dd3cc177ac0297ff308fa36ee8b2e93e9b215.patch
790fd35fe6d28e3c97108db36d96420340ba84eec5044c408b903fcb649d8badcd4cb449074d33f949e3ab4906125997229148c32face15742ca56da002adbf9  76ca4ee7b4ef5f9a87688a5893e3bd5df819f455.patch
001c1638b168ca83b5388ab2c294f459d8cc0e7785731bd2974ebf052692d97ed3bf39e765ab06a49dfb6a005bcdd74e406298312c0ea58a99eb7354891ba7ea  a935fcd9bdf5d7e06143e557a42d861f549c809d.patch
dc9989b612dd3ec2d5d1ee11eb786dfc2f71810628785d1c84f38744fbd02ab1069312c6374e9de3ad622df1e88678e5d0069552de19008e0298afe267fe65de  7c11e06361e707448e99dae7ef8ea6aa53d16375.patch
b5c0eb2c25a9b89f3a7547b70bd22f948db87217fe7f83ef076de463001da708e0092c0319e84e0d2e0cca0045af688f4f1ca186765a29ffa76cebd38e2fdef2  0fc66875a59ec2c8912a70a9c9c845affda8ca22.patch
9bdb697b1bf0c6e0299668137e0b7d2b6147500d89577f3c8655240a557967ce658e28afbb794eaa8e81240f63d849857814137d0492ace2fd52e5eeee2b9aec  83b0ace09f44f51477b91fb8184fc89efd38d108.patch
cd27c22c572571da2c359127c0684004dab6106423cc345ab7e7abfa4b08158b799ddbe7377e9bfc384cc16410875df4d652a98ed8c1068ca0f4045e0d1d9a3f  cc5e8eceff89977f3ba1188edc4e565cde026b06.patch
0670c956d0b7509201b9462d8f3cf4d8d6d9900ec2403dbed2f3b7546377eecb56004fda8b9229162acaab5032cd9fa8c580bab87e11f00c4b1f647b45bb8ffb  558f83819d68f4ea5da9945fcf205c89cc2a6086.patch
706fa00fcd4d9d4b67ce4f8ae86772ab43b1b5e47335ac93654321360661c12fa54fdcd1299a1456e768eb205dab935b97486099c405d7fce471004cb804a8f7  9850125e9e6c34794ae84b89d0d323e5d9978879.patch
f05a8f4b21d8438ad036a6b43077caed71e3a709c9be8d036f3c811b440e2db33bcbbf8d30a41bd4f03c75ed31ba68596d963ff8fde6468c809ced8ab3bfcd76  945cae4a8a1ca424670188bc9ab9c41bdcb99379.patch"
